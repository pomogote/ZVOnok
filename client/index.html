<!DOCTYPE html>
<html>

<meta charset="UTF-8">

<head>
    <title>Messenger Demo</title>
    <style>
        body {
            font-family: Arial;
            max-width: 800px;
            margin: 0 auto;
        }

        #auth,
        #chat {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
        }

        .message {
            margin: 10px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        #voiceBtn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
        }
    </style>
</head>

<body>
    <!-- –§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="auth">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="register()">Register</button>
        <button onclick="login()">Login</button>
    </div>

    <div id="currentRoom" style="margin:10px 0; font-weight:bold;"></div>

    <button id="logoutBtn">–í—ã–π—Ç–∏</button>
    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–∞ -->
    <div id="chat" style="display: none;">
        <div id="rooms">
            <button onclick="createRoom()">Create Room</button>
            <div id="roomList"></div>
        </div>

        <div id="messages"></div>

        <input type="text" id="messageInput" placeholder="Message">
        <button onclick="sendMessage()">Send</button>
        <button id="voiceBtn" onmousedown="startRecording()" onmouseup="stopRecording()">
            üé§ Hold to record
        </button>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let currentUser = null;
        let currentRoom = null;
        let socket = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // API –º–µ—Ç–æ–¥—ã
        async function register() {
            const response = await fetch('http://localhost:3000/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: 'Test User',
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value
                }),
                credentials: 'include'
            });
            const data = await response.json();
            console.log('Registered:', data);
        }

        socket.on('newMessage', (message) => {
            console.log('–ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
            if (message.is_voice_message) {
                addVoiceMessageToUI(message);
            } else {
                addTextMessageToUI(message);
            }
        });

        async function login() {
            const response = await fetch('http://localhost:3000/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value
                })
            });

            const data = await response.json();
            if (data.token) {
                localStorage.setItem('token', data.token);

                // –ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è
                const profileRes = await fetch('http://localhost:3000/api/profile', {
                    headers: { Authorization: `Bearer ${data.token}` }
                });
                currentUser = await profileRes.json();

                initChat(data.token);
            } else {
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function addVoiceMessageToUI(message) {
            const messagesContainer = document.getElementById('messages');

            const messageElem = document.createElement('div');
            messageElem.className = 'message voice';

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–º–µ–Ω–µ–º
            const header = document.createElement('div');
            header.innerHTML = `
    <span class="user-name">${message.user_name}</span>
    <span class="time">${new Date(message.created_at).toLocaleTimeString()}</span>
  `;

            // –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.innerHTML = `
    <source src="http://localhost:3000${message.file_url}" type="audio/webm">
    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
  `;

            messageElem.appendChild(header);
            messageElem.appendChild(audio);
            messagesContainer.appendChild(messageElem);

            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addMessageToUI(message) {
            const messagesContainer = document.getElementById('messages');

            // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –º–µ—Ç–∫—É –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö
            if (message.is_voice_message) {
                message.text = "";
            }

            const messageElem = document.createElement('div');
            messageElem.classList.add('message');

            // –ë–ª–æ–∫ –∞–≤—Ç–æ—Ä–∞
            const author = document.createElement('div');
            author.style.color = "#666";
            author.textContent = `${message.user_name}:`;
            messageElem.appendChild(author);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö
            if (message.is_voice_message && message.file_url) {
                const audioWrapper = document.createElement('div');
                audioWrapper.style.marginTop = "5px";

                const audio = document.createElement('audio');
                audio.controls = true;
                audio.style.width = "250px";

                const source = document.createElement('source');
                source.src = `http://localhost:3000${message.file_url}`;
                source.type = 'audio/webm';

                audio.appendChild(source);
                audioWrapper.appendChild(audio);
                messageElem.appendChild(audioWrapper);
            }
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö
            else if (message.text) {
                const textElem = document.createElement('div');
                textElem.textContent = message.text;
                messageElem.appendChild(textElem);
            }

            messagesContainer.appendChild(messageElem);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function initChat(token) {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('chat').style.display = 'block';

            socket = io('http://localhost:3000', {
                extraHeaders: {
                    Authorization: `Bearer ${token}`
                }
            });


            //–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
            socket.on('connect', () => {
                console.log('Socket connected:', socket.id);
            });

            // socket.on('newMessage', (msg) => {
            //     console.log('New message received:', msg);
            //     addMessageToUI(msg);
            // });

            socket.on('newMessage', (message) => {
                addMessageToUI({
                    userId: message.sender_id,
                    userName: message.user_name,
                    text: message.text,
                    isVoiceMessage: message.is_voice_message,
                    fileUrl: message.file_url
                });
            });

            // –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

            loadRooms();
        }

        async function createRoom() {
            await fetch('http://localhost:3000/api/rooms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ name: prompt('Room name:') })
            });
            loadRooms();
        }

        document.getElementById('logoutBtn').onclick = function () {
            localStorage.removeItem('token');
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É, –≤–æ–∑–≤—Ä–∞—â–∞—è –Ω–∞ —Ñ–æ—Ä–º—É –ª–æ–≥–∏–Ω–∞
        };

        async function joinRoom(roomId, roomName) {
            currentRoom = roomId;
            document.getElementById('currentRoom').textContent = "–¢–µ–∫—É—â–∞—è –∫–æ–º–Ω–∞—Ç–∞: " + roomName;
            document.getElementById('messages').innerHTML = ""; // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            socket.emit('joinRoom', roomId);

            try {
                const response = await fetch(`http://localhost:3000/api/chat/rooms/${roomId}/messages`, {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const messages = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è:', messages);
                messages.forEach(addMessageToUI);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            }
        }

        async function loadRooms() {
            document.getElementById('roomList').innerHTML = "";
            const response = await fetch('http://localhost:3000/api/rooms', {
                headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
            });
            const rooms = await response.json();
            rooms.forEach(room => {
                const btn = document.createElement('button');
                btn.textContent = room.name;
                btn.onclick = () => joinRoom(room.id, room.name);
                document.getElementById('roomList').appendChild(btn);
            });
        }

        function sendMessage() {
            if (!currentRoom) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }

            const message = document.getElementById('messageInput').value.trim();
            if (!message) return;

            socket.emit('sendMessage', {
                text: message,
                roomId: currentRoom
            });

            document.getElementById('messageInput').value = '';
        }

        // –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm; codecs=opus' // –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –∫–æ–¥–µ–∫–æ–≤
            });
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.start();
        }

        async function stopRecording() {
            mediaRecorder.stop();
            mediaRecorder.onstop = async () => {
                try {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const formData = new FormData();
                    formData.append('voice', audioBlob, 'recording.webm');
                    formData.append('roomId', currentRoom);

                    const response = await fetch('http://localhost:3000/api/chat/voice', {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${localStorage.getItem('token')}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
                } finally {
                    audioChunks = [];
                }
            };
        }



        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (localStorage.getItem('token')) {
            initChat(localStorage.getItem('token'));
        }
    </script>
</body>

</html>






<!-- socket.on('newMessage', (message) => {
                if (message.is_voice_message) {
                    // 1. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL
                    //const audioUrl = `http://localhost:3000/uploads${message.file_url}`;
                    const audioUrl = `http://localhost:3000${message.file_url}`;

                    // 2. –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥ source —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º MIME-—Ç–∏–ø–∞
                    const audio = document.createElement('audio');
                    audio.controls = true;

                    const source = document.createElement('source');
                    source.src = audioUrl;
                    source.type = 'audio/webm'; // –∏–ª–∏ 'audio/wav' –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞

                    // 3. –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
                    audio.onerror = function () {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', {
                            src: audioUrl,
                            error: this.error
                        });
                    };

                    audio.appendChild(source);

                    // 3. –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
                    audio.onerror = function () {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:', this.error);
                    };

                    const messageDiv = document.createElement('div');
                    messageDiv.appendChild(audio);
                    document.getElementById('messages').appendChild(messageDiv);
                }
            }); -->





<!-- function addMessageToUI(message) {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;

            const messageElem = document.createElement('div');
            messageElem.classList.add('message');

            if (message.text) {
                // –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                messageElem.textContent = `${message.userName || message.userId}: ${message.text}`;
            } else if (message.audioUrl) {
                // –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = message.audioUrl;
                messageElem.appendChild(document.createTextNode(`${message.userName || message.userId}: `));
                messageElem.appendChild(audio);
            } else {
                messageElem.textContent = `${message.userName || message.userId}: [–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]`;
            }

            messagesContainer.appendChild(messageElem);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } -->


<!-- 
        function addMessage(message) {
            const div = document.createElement('div');
            div.className = 'message';

            if (message.is_voice_message) {
                div.innerHTML = `üé§ <audio controls src="http://localhost:3000/uploads${message.file_url}"></audio>`;
            } else {
                div.textContent = `${message.sender_id}: ${message.text}`;
            }

            document.getElementById('messages').appendChild(div);
        } -->